<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>reclamos</title>
</head>
<body>

    <form action="" class="contendioFormulario" id="claimForm" enctype="multipart/form-data">

        <!-- datos de validación  -->
        <div class="contenedorPreguntas" id="datosValidacionAbonado">

            <details id="contenedorDatosValidacionAbonado">
                <summary>Datos de validación</summary>
                    <div class="datosPersonales" id="formulario_personal">
                        <div class="contenedorDatosPersonales">
        
                            <div class="datos">
                                <label for="nombrePadre">Nombre del Padre</label>
                                <input type="text" id="nombrePadre" placeholder="Nombre del Padre">
                            </div>
                    
                            <div class="datos">
                                <label for="nombreMadre">Nombre del Madre</label>
                                <input type="text" id="nombreMadre" placeholder="Nombre de la Madre">
                            </div>
                    
                            <div class="datos">
                                <label for="lugarNacimiento">Lugar de Nacimiento</label>
                                <input type="text" id="lugarNacimiento" placeholder="Lugar de Nacimiento">
                            </div>
                    
                            <div class="datos">
                                <label for="fechaNacimiento">Fecha de Nacimiento</label>
                                <input type="date" class="fecha" id="fechaNacimiento">
                            </div>
        
                        </div>
                    </div>
        
                    <div class="btnContinuar">
                        <input type="button" id="validarFormularioAbonado" value="Validar">
                    </div>
        
            </details>
                    
        </div>
        
        <div class="contenedorPreguntas" id="datosValidacionUsuario">
                    
            <details id="contenedorDatosValidacionUsuario">
                <summary>Datos de validación</summary>
                    <div class="datosPersonales" id="formulario_personal">
                        <div class="contenedorDatosPersonales">
            
                            <div class="datos">
                                <label for="fechaVencimiento">Fecha de Vencimiento del Recibo</label>
                                <input type="date" class="fecha" class="fecha" id="fechaVencimiento">
                            </div>
            
                            <div class="datos">
                                <label for="montoTarifa">Monto del plan tarifario</label>
                                <input type="text" id="montoTarifa" placeholder="Monto del plan tarifario">
                            </div>
            
                            <div class="datos">
                                <label for="direccionFacturacion">Dirección de Facturación</label>
                                <input type="text" id="direccionFacturacion" placeholder="Dirección">
                            </div>
            
                        </div>
                    </div>
        
                    <div class="btnContinuar">
                        <input type="button" id="validarFormularioUsuario" value="Validar">
                    </div>
        
            </details>
                    
        </div>

        <details id="contenedorDatosPersonalesDetails">

            <summary id="tipoUsers">Datos Personales</summary>
            
            <div class="contenedorDatosPersonales">
    
                <div class="datos">
                    <label for="name">Nombres</label>
                    <input type="text" id="name" name="name" placeholder="Nombre del reclamante" required>
                </div>
                <div class="datos">
                    <label for="apellidos">Apellidos</label>
                    <input type="text" id="apellidos" name="apellidos" placeholder="Apellidos del reclamante" required>
                </div>
                <div class="datos" id="extra_usuario">
                    <label for="relacion">Especifique su relación con el cliente</label>
                    <input type="text" id="relacion" placeholder="Madre, Padre, Hijo, etc.">
                </div>
                <div class="contenedorDatosPersonales" id="extra_representante">
                    <div class="datos">
                        <label for="razonsocial">Razón Social</label>
                        <input type="text" id="razonsocial" placeholder="Razón social">
                    </div>
                    <div class="datos">
                        <label for="cartaPoder">Adjuntar de Carta Poder</label>
                        <input type="file" name="cartaPoder" id="cartaPoder" accept=".pdf, .jpg, .jpeg, .png, .doc, .docx">
                    </div>
                </div>
                <div class="datos">
                    <label for="numeroContacto">Número de contacto</label>
                    <input type="text" name="numeroContacto" id="numeroContacto" placeholder="Número de contacto" max="9" required>
                </div>
                <div class="datos">
                    <label for="tipoDoc">Tipo de Documento</label>
                    <select name="tipoDoc" id="tipoDoc" onchange="tipoDocumento()">
                        <option value="">Selecciona un tipo de documento</option>
                        <option value="DNI">Documento de Identidad (DNI)</option>
                        <option value="RUC">Registro Único de Contribuyentes (RUC)</option>
                        <option value="Pasaporte">Pasaporte</option>
                        <option value="CE">Carnet de Extranjería(CE)</option>
                        <option value="Otro_Documento">Documento Legal de Identidad válido requerido por la Superintendencia Nacional de Migraciones</option>
                    </select>
                </div>
                <div class="datos">
                    <label for="numDoc">Número de Documento</label>
                    <input type="text" class="" id="numDoc" placeholder="Número de identidad" max="9" required>
                </div>
                <div class="datos">
                    <label for="distritos">Distrito</label>
                    <select name="distritos" id="distritos" onchange="">
                        <option value="">Seleccionar Opción</option>
                        <option value="Ate">Ate</option>
                        <option value="Ancón">Ancón</option>
                        <option value="Carabayllo">Carabayllo</option>
                        <option value="Chaclacayo">Chaclacayo</option>
                        <option value="Comas">Comas</option>
                        <option value="El Agustino">El Agustino</option>
                        <option value="Ica">Ica</option>
                        <option value="Independencia">Independencia</option>
                        <option value="La Victoria">La Victoria</option>
                        <option value="Los Olivos">Los Olivos</option>
                        <option value="Puente Piedra">Puente Piedra</option>
                        <option value="Rimac">Rimac</option>
                        <option value="San Juan de Lurigancho">San Juan de Lurigancho</option>
                        <option value="San Martín de Porres">San Martín de Porres</option>
                        <option value="Santa Rosa">Santa Rosa</option>
                    </select>
                </div>
                <div class="datos">
                    <label for="direccion">Dirección</label>
                    <input type="text" class="" name="datosPersonales" id="direccion" placeholder="Dirección" required>
                </div>
                <div class="datos">
                    <label for="correo">Correo electrónico</label>
                    <input type="email" class="" name="datosPersonales" id="correo" placeholder="ejemplo@gmail.com" required>
                </div>
                
            </div>

            <div class="datos_solo" id="escojerCorreo">
                <p>Autoriza ser notificado por correo electrónico </p>
                <div class="opcionCorreo">
                    <div class="oCorreo">
                        <label for="autoriza">Si</label>
                        <input type="radio" name="autorizacion" id="autorizaSi" value="True">
                    </div>
                    <div class="oCorreo">
                        <label for="autoriza">No</label>
                        <input type="radio" name="autorizacion" id="autorizaNo" value="False">
                    </div>
                </div>
            </div>
            
            <div class="btnContinuar">
                <input type="button" id="validarFormularioContinuar" value="Continuar">
            </div>
                    
        </details>

        <button type="submit">enviar</button>

    </form>

        <script>

        // Función para convertir un archivo a base64
        function convertFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = function () {
                    resolve(reader.result.split(',')[1]);  // Devuelve solo la parte base64
                };
                reader.onerror = function (error) {
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        }

        // Función para enviar el formulario como JSON
        document.getElementById("claimForm").addEventListener("submit", async function(event) {
            event.preventDefault();  // Prevenir el envío normal del formulario

            // usuarios
            // Variables para almacenar el tipo de usuario
            const tipoUsuarioSeleccionado = "";

            
            // datos de validacion abonado
            const nombrePadre = document.getElementById('nombrePadre').value.trim();
            const nombreMadre = document.getElementById('nombreMadre').value.trim();
            const lugarNacimiento = document.getElementById('lugarNacimiento').value.trim();
            const fechaNacimiento = document.getElementById('fechaNacimiento').value;
            // datos de validacion usuario
            const fechaVencimiento = document.getElementById('fechaVencimiento').value;
            const montoTarifa = document.getElementById('montoTarifa').value.trim();
            const direccionFacturacion = document.getElementById('direccionFacturacion').value.trim();
            // datos personales
            const nombres = document.getElementById('name').value.trim();
            const apellidos = document.getElementById('apellidos').value.trim();
            const relacion = document.getElementById('relacion').value.trim();
            const razonSocial = document.getElementById('razonsocial').value.trim();
            const numeroContacto = document.getElementById('numeroContacto').value.trim();
            const tipoDoc = document.getElementById('tipoDoc').value.trim();
            const numDoc = document.getElementById('numDoc').value.trim();
            const distritos = document.getElementById('distritos').value.trim();
            const direccion = document.getElementById('direccion').value.trim();
            const correo = document.getElementById('correo').value.trim();
                // Obtener el valor de la autorización (True o False)
            const autoriza = document.querySelector('input[name="autorizacion"]:checked') ? 
                            document.querySelector('input[name="autorizacion"]:checked').value : 
                            "False"; // Valor predeterminado si no se selecciona nada

            
            const fileInput = document.getElementById('cartaPoder');

            //const documentoSolicitudX=vinculoSolicitudSX.files[0];
            
            const file = fileInput.files[0];  // Archivo de carta de poder

            let fileBase64 = "";
            // Solo convertimos a base64 si se selecciona un archivo
            if (file) {
                try {
                    fileBase64 = await convertFileToBase64(file);
                } catch (error) {
                    console.error('Error al convertir archivo de carta de poder:', error);
                }
            }

            // datos para envio de reclamos


            const data = {

                // //
                tipoUsuarioSeleccionado,
                //tipoticket,
                // diagnostico,
                // datos de validacion
                nombrePadre,
                nombreMadre,
                lugarNacimiento,
                fechaNacimiento,
                //datos de validacion
                fechaVencimiento,
                montoTarifa,
                direccionFacturacion,

                cartaPoder: fileBase64,  // Será una cadena vacía si no se cargó un archivo
                nombre: nombres,
                apellidos,
                relacion,
                razonSocial,
                numeroContacto,
                tipoDoc,
                numDoc,
                distritos,
                direccion,
                correo,
                autoriza:autoriza,

                // preguntas de reclamos


            };

            // Enviar la solicitud POST a la API Flask
            try {
                const response = await fetch('https://pruebados-f80ed8a83d18.herokuapp.com/api/reclamos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                const responseData = await response.json();
                const messageDiv = document.getElementById('message');

                if (responseData.error) {
                    messageDiv.innerHTML = `<span class="error">${responseData.error}</span>`;
                } else {
                    messageDiv.innerHTML = `<span class="success"> Número: ${responseData.ticket_id} </span>`;
                    ocultarBotonesYRedirigir();    
                    const btns=document.getElementById("btnEnviarFormulario");
                    btns.style.display="none";
                }
            } catch (error) {
                const messageDiv = document.getElementById('message');
                messageDiv.innerHTML = `<span class="error">Hubo un problema al enviar la solicitud: ${error.message}</span>`;
            }


        })
        
    </script>
    
</body>
</html>